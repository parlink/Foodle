{% extends 'base_content.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-4">
    <!-- Header and Navigation -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <a href="{% url 'tracker' %}" class="text-decoration-none text-muted small mb-1 d-inline-block">
                <i class="bi bi-arrow-left"></i> Back to Tracker
            </a>
            <h1 class="h3 mb-0">Fasting History</h1>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
             <div class="btn-group btn-group-sm" role="group">
                <a href="?view_type=week&date_offset=0" class="btn btn-outline-primary {% if view_type == 'week' %}active{% endif %}">Weekly</a>
                <a href="?view_type=month&date_offset=0" class="btn btn-outline-primary {% if view_type == 'month' %}active{% endif %}">Monthly</a>
            </div>
        </div>
    </div>

    <!-- Date Controls -->
    <div class="card mb-4 bg-light border-0">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <a href="?view_type={{ view_type }}&date_offset={{ date_offset|add:'-1' }}" class="btn btn-link text-decoration-none text-secondary">
                    <i class="bi bi-chevron-left"></i> Prev
                </a>
                
                <span class="fw-bold">
                    {% if view_type == 'week' %}
                        {{ start_date|date:"M d" }} - {{ end_date|date:"M d, Y" }}
                    {% else %}
                        {{ start_date|date:"F Y" }}
                    {% endif %}
                </span>
                
                {% if show_next %}
                    <a href="?view_type={{ view_type }}&date_offset={{ date_offset|add:'1' }}" class="btn btn-link text-decoration-none text-secondary">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                {% else %}
                    <span class="btn btn-link text-decoration-none text-muted disabled" style="cursor: default;">
                        Next <i class="bi bi-chevron-right"></i>
                    </span>
                {% endif %}
            </div>
        </div>
    </div>




    <!-- Chart Container -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <div style="height: 300px; position: relative;">
                <canvas id="fastingChart"></canvas>
            </div>
        </div>
    </div>





    <!-- Data List -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0 fs-6 text-muted text-uppercase">Detailed Log</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="ps-3">Date</th>
                        <th scope="col">Start Time</th>
                        <th scope="col">End Time</th>
                        <th scope="col">Duration</th>
                        <th scope="col" class="text-end pe-3">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in table_data %}
                        <tr>
                            <td class="ps-3 fw-medium">{{ session.date|date:"D, M d" }}</td>
                            <td>{{ session.start_time|date:"g:i A" }}</td>
                            <td>{{ session.end_time|date:"g:i A" }}</td>
                            <td>{{ session.duration_str }}</td>
                            <td class="text-end pe-3">
                                {% if session.is_active %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 rounded-pill">
                                        <i class="bi bi-clock-history me-1"></i> Active (Running)
                                    </span>
                                {% elif session.met_goal %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill">
                                        <i class="bi bi-check-circle-fill me-1"></i> Goal Met
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill">
                                        {{ session.goal }}h Goal
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">No fasting sessions recorded for this period.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Edit Modal -->
<div class="modal fade" id="editFastingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Fasting Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_session">
                <input type="hidden" name="session_id" id="editSessionId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editStartTime" class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-control" id="editStartTime" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEndTime" class="form-label">End Time</label>
                        <input type="datetime-local" class="form-control" id="editEndTime" name="end_time">
                        <div class="form-text">Clear this to make the session active again.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editModal = document.getElementById('editFastingModal');
        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const start = button.getAttribute('data-start');
            const end = button.getAttribute('data-end');
            
            document.getElementById('editSessionId').value = id;
            document.getElementById('editStartTime').value = start;
            document.getElementById('editEndTime').value = end === 'None' ? '' : end;
        });
    });
</script>

<script id="chart-data" type="application/json">
    {
        "labels": [{% for label in chart_labels %}"{{ label }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        "data": [{% for value in chart_data %}{{ value }}{% if not forloop.last %},{% endif %}{% endfor %}],
        "goals": [{% for value in chart_goal_data %}{{ value }}{% if not forloop.last %},{% endif %}{% endfor %}]
    }
</script>




<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('fastingChart').getContext('2d');
        const viewType = '{{ view_type }}';
        
        //Data from Django via hidden script tag to avoid syntax errors
        const chartDataElement = document.getElementById('chart-data');
        const chartData = JSON.parse(chartDataElement.textContent);
        
        //Chart Config
        const chartConfig = {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: viewType === 'month' ? 'Avg Duration (hours)' : 'Duration (hours)',
                        data: chartData.data,
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: 'Goal Target',
                        data: chartData.goals,
                        type: 'line',
                        borderColor: '#ffc107',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        fill: false,
                        order: 1,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + 'h';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Hours'
                        },
                        grid: {
                            borderDash: [2, 4],
                            color: '#f0f0f0'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        };

        new Chart(ctx, chartConfig);
    });
    
</script>


{% endblock %}

