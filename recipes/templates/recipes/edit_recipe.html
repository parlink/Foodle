{% extends "base_content.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card card-style">
        <div class="card-header border-0 bg-transparent d-flex align-items-center justify-content-between">
          <h4 class="mb-0 fw-bold">
            <i class="bi bi-pencil-square me-2"></i>Edit Recipe
          </h4>
          <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-sm btn-outline-secondary">
            Back
          </a>
        </div>

        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="editRecipeForm">
            {% csrf_token %}

            <!-- Recipe Name -->
            <div class="mb-3">
              <label for="id_name" class="form-label fw-semibold">Recipe Name</label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors }}</div>
              {% endif %}
            </div>

            <!-- Current image preview (optional but helpful) -->
            {% if recipe.image %}
              <div class="mb-3">
                <label class="form-label fw-semibold">Current Photo</label>
                <div class="mb-2">
                  <img
                    src="{{ recipe.image.url }}"
                    alt="{{ recipe.name }}"
                    class="img-fluid rounded"
                    style="max-height: 250px; object-fit: cover;"
                  />
                </div>
              </div>
            {% endif %}

            <!-- Photo Upload -->
            <div class="mb-3">
              <label for="id_image" class="form-label fw-semibold">Replace Photo</label>
              {{ form.image }}
              <div class="form-text">Upload a new photo to replace the existing one (optional)</div>
              {% if form.image.errors %}
                <div class="text-danger small">{{ form.image.errors }}</div>
              {% endif %}
            </div>

            <!-- Your Rating -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Your Rating</label>
              <div class="star-rating-input d-flex gap-1" id="ratingInput">
                {% for i in "12345" %}
                  <i class="bi bi-star fs-4 star-select" data-rating="{{ i }}" style="cursor: pointer;"></i>
                {% endfor %}
                {{ form.personal_rating }}
              </div>
              {% if form.personal_rating.errors %}
                <div class="text-danger small">{{ form.personal_rating.errors }}</div>
              {% endif %}
            </div>

            <div class="row">
              <!-- Difficulty -->
              <div class="col-md-6 mb-3">
                <label for="id_difficulty" class="form-label fw-semibold">Difficulty</label>
                {{ form.difficulty }}
                {% if form.difficulty.errors %}
                  <div class="text-danger small">{{ form.difficulty.errors }}</div>
                {% endif %}
              </div>

              <!-- Duration -->
              <div class="col-md-6 mb-3">
                <label for="id_total_time" class="form-label fw-semibold">Duration</label>
                {{ form.total_time }}
                {% if form.total_time.errors %}
                  <div class="text-danger small">{{ form.total_time.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <!-- Servings -->
              <div class="col-md-6 mb-3">
                <label for="id_servings" class="form-label fw-semibold">Servings</label>
                {{ form.servings }}
                {% if form.servings.errors %}
                  <div class="text-danger small">{{ form.servings.errors }}</div>
                {% endif %}
              </div>

              <!-- Calories -->
              <div class="col-md-6 mb-3">
                <label for="id_calories" class="form-label fw-semibold">Calories (per serving)</label>
                {{ form.calories }}
                {% if form.calories.errors %}
                  <div class="text-danger small">{{ form.calories.errors }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Ingredients -->
            <div class="mb-3">
              <label for="id_ingredients" class="form-label fw-semibold">Ingredients</label>
              {{ form.ingredients }}
              <div class="form-text">Separate each ingredient with a comma</div>
              {% if form.ingredients.errors %}
                <div class="text-danger small">{{ form.ingredients.errors }}</div>
              {% endif %}
            </div>

            <!-- Instructions -->
            <div class="mb-3">
              <label for="id_method" class="form-label fw-semibold">Instructions</label>
              {{ form.method }}
              <div class="form-text">Enter each step on a new line</div>
              {% if form.method.errors %}
                <div class="text-danger small">{{ form.method.errors }}</div>
              {% endif %}
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-emerald">
                <i class="bi bi-check-lg me-1"></i>Save Changes
              </button>
              <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-secondary">
                Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const stars = document.querySelectorAll('.star-select');
  const ratingInput = document.getElementById('id_personal_rating');

  function paint(rating) {
    stars.forEach((s, index) => {
      if (index < rating) {
        s.classList.remove('bi-star');
        s.classList.add('bi-star-fill', 'text-warning');
      } else {
        s.classList.remove('bi-star-fill', 'text-warning');
        s.classList.add('bi-star');
      }
    });
  }

  // Pre-fill stars from existing value
  const initialRating = parseInt(ratingInput.value) || 0;
  paint(initialRating);

  stars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.dataset.rating);
      ratingInput.value = rating;
      paint(rating);
    });

    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.dataset.rating);
      stars.forEach((s, index) => {
        if (index < rating) s.classList.add('text-warning');
      });
    });

    star.addEventListener('mouseleave', function() {
      const currentRating = parseInt(ratingInput.value) || 0;
      stars.forEach((s, index) => {
        if (index >= currentRating) s.classList.remove('text-warning');
      });
    });
  });
});
</script>
{% endblock %}
